# Generated by iptables-save v1.4.21 on Wed May  4 20:43:54 2016
*mangle
:PREROUTING ACCEPT [2397:231640]
:INPUT ACCEPT [2397:231640]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [2130:367881]
:POSTROUTING ACCEPT [2130:367881]
COMMIT
# Completed on Wed May  4 20:43:54 2016
# Generated by iptables-save v1.4.21 on Wed May  4 20:43:54 2016
*filter
:INPUT DROP [106:4074]
:FORWARD DROP [0:0]
:OUTPUT DROP [0:0]

# Docker
:DOCKER - [0:0]
:DOCKER-ISOLATION - [0:0]

# Allow established connections
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
# Allow connections from deployment machine, localhost and docker network
-A INPUT -s {{ deployment_ip }} -p tcp -m tcp --dport 40000 -j ACCEPT
-A INPUT -s {{ deployment_ip }} -p tcp -m tcp --dport 389 -j ACCEPT
-A INPUT -s 127.0.0.1/32 -p tcp -m tcp -j ACCEPT
-A INPUT -s {{ docker_network }} -p tcp -m tcp -j ACCEPT
# Allow connections for consultation (http(s))
-A INPUT -p tcp -m tcp --dport 80 -j ACCEPT
-A INPUT -p tcp -m tcp --dport 443 -j ACCEPT
# Allow connections from OVH (supervision)
{% for item in ovh_ip %}
-A INPUT -s {{ item }} -j ACCEPT
{% endfor %}
# Log everything else
-A INPUT -j LOG

# Docker
-A FORWARD -j DOCKER-ISOLATION
-A FORWARD -o {{ docker_interface }} -j DOCKER
-A FORWARD -o {{ docker_interface }} -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A FORWARD -i {{ docker_interface }} ! -o {{ docker_interface }} -j ACCEPT
-A FORWARD -i {{ docker_interface }} -o {{ docker_interface }} -j ACCEPT

# Allow port forwarding for dockers deployment (ssh)
-A FORWARD -s {{ deployment_ip }} -d {{ elasticsearch_ip }} -p tcp -m tcp --dport 22 -j ACCEPT
-A FORWARD -s {{ deployment_ip }} -d {{ logstash_ip }} -p tcp -m tcp --dport 22 -j ACCEPT
-A FORWARD -s {{ deployment_ip }} -d {{ kibana_ip }} -p tcp -m tcp --dport 22 -j ACCEPT

# Allow connections from inside
-A OUTPUT -m state --state NEW,RELATED,ESTABLISHED -j ACCEPT
-A DOCKER-ISOLATION -j RETURN
COMMIT
# Completed on Wed May  4 20:43:54 2016
# Generated by iptables-save v1.4.21 on Wed May  4 20:43:54 2016
*nat
:PREROUTING ACCEPT [220:8354]
:INPUT ACCEPT [2:120]
:OUTPUT ACCEPT [68:4924]
:POSTROUTING ACCEPT [68:4924]
# Docker
:DOCKER - [0:0]
-A PREROUTING -m addrtype --dst-type LOCAL -j DOCKER

# Allow port forwarding for dockers deployment (ssh)
-A PREROUTING -s {{ deployment_ip }} -i eth0 -p tcp -m tcp --dport 40002 -j DNAT --to-destination {{ elasticsearch_ip }}:22
-A PREROUTING -s {{ deployment_ip }} -i eth0 -p tcp -m tcp --dport 40003 -j DNAT --to-destination {{ logstash_ip }}:22
-A PREROUTING -s {{ deployment_ip }} -i eth0 -p tcp -m tcp --dport 40004 -j DNAT --to-destination {{ kibana_ip }}:22

-A OUTPUT ! -d 127.0.0.0/8 -m addrtype --dst-type LOCAL -j DOCKER
-A POSTROUTING -s {{ docker_network }} ! -o {{ docker_interface }} -j MASQUERADE
-A DOCKER -i {{ docker_interface }} -j RETURN
COMMIT
# Completed on Wed May  4 20:43:54 2016
